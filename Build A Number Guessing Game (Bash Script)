#!/bin/bash

PSQL="psql --username=freecodecamp --dbname=number_guess -t --no-align -c"

#Random number generator
NUMBER_TO_GUESS=$(( 1 + $RANDOM % 1000 ))
#TEST: echo $NUMBER_TO_GUESS

echo -e "\n~~~~~ NUMBER GUESSING GAME ~~~~~\n"
#Enter username
echo "Enter your username:"
read USERNAME

#Check database for username
RECORD=$($PSQL "SELECT game_no, best_game FROM user_data WHERE username = '$USERNAME'")
if [[ -z $RECORD ]]
then
  #If not in database
  echo -e "\nWelcome, $USERNAME! It looks like this is your first time here."
  #Save username to database
  echo $($PSQL "INSERT INTO user_data(username) VALUES('$USERNAME')")
  echo $($PSQL "UPDATE user_data SET game_no = 1 WHERE username = '$USERNAME'")
  echo $($PSQL "UPDATE user_data SET best_game = 999 WHERE username = '$USERNAME'")
else

  #If username is in database
  echo $RECORD | while IFS="|" read GAME_NO BEST_GAME
  do
    echo -e "\nWelcome back, $USERNAME! You have played $GAME_NO games, and your best game took $BEST_GAME guesses."
  done

fi

echo $($PSQL "TRUNCATE guess")
echo $($PSQL "ALTER SEQUENCE guess_no_seq RESTART")

MAIN_GAME() {

  #Collect guessed number
  echo -e "\nGuess the secret number between 1 and 1000:"
  read GUESSED_NUMBER

  if [[ ! $GUESSED_NUMBER =~ ^[0-9]+$ ]]
  then
    #If not an integer
    echo -e "\nThat is not an integer, guess again:"
    MAIN_MENU
  else
    #Compare guessed number with generated number
    if [[ $GUESSED_NUMBER > $NUMBER_TO_GUESS ]]
    then
    #If lower
      echo "It's lower than that, guess again:"
      echo $($PSQL "INSERT INTO guess(guess) VALUES($GUESSED_NUMBER)")
      #TEST: GUESS_NO=$($PSQL "SELECT MAX(no) FROM guess")
      #TEST: echo $GUESS_NO
      MAIN_GAME
    elif [[ $GUESSED_NUMBER < $NUMBER_TO_GUESS ]]
    then
    #If higher
      echo "It's higher than that, guess again:"
      echo $($PSQL "INSERT INTO guess(guess) VALUES($GUESSED_NUMBER)")
      #TEST: GUESS_NO=$($PSQL "SELECT MAX(no) FROM guess")
      #TEST: echo $GUESS_NO
      MAIN_GAME
    else
    #If same
      NO_OF_GUESS=$($PSQL "SELECT MAX(no) FROM guess")
      echo "You guessed it in $NO_OF_GUESS tries. The secret number was $NUMBER_TO_GUESS. Nice job!"
      #Compare number of guesses with best game
      BEST_GAME=$($PSQL "SELECT best_game FROM user_data WHERE username = '$USERNAME'")
      echo "NO OF GUESS: $NO_OF_GUESS"
      echo "BEST GAME: $BEST_GAME"
      
      if [[ $NO_OF_GUESS < $BEST_GAME ]]
      then
        echo $($PSQL "UPDATE user_data SET best_game = $NO_OF_GUESS where username = '$USERNAME'")
      fi
      #Update no of games played
      GAME_NO=$($PSQL "SELECT game_no FROM user_data WHERE username = '$USERNAME'")
      echo $($PSQL "UPDATE user_data SET game_no = $GAME_NO + 1 where username = '$USERNAME'")
    fi
  fi
  
}

MAIN_GAME
